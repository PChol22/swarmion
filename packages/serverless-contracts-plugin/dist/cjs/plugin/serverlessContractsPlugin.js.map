{"version":3,"file":"serverlessContractsPlugin.js","names":["ServerlessContractsPlugin","serverless","cliOptions","log","strategy","undefined","Object","values","DeploymentStrategies","includes","Error","JSON","stringify","configSchemaHandler","defineTopLevelProperty","serviceOptionsSchema","commands","localContracts","usage","lifecycleEvents","remoteContracts","safeDeploy","options","shortcut","required","type","generateOpenApiDocumentation","hooks","printLocalServerlessContractSchemas","bind","printRemoteServerlessContractSchemas","deployWithContractSchemasValidation","validateDeployment","tagStackWithTimestamp","uploadContractSchemas","pluginManager","spawn","listLocalContractSchemas","contractSchemas","printContractSchemas","ContractSchemasLocation","LOCAL","listRemoteContractSchemas","error","REMOTE","artifactDirectoryName","service","timestamp","getTimestampFromArtifactDirectoryName","provider","stackTags","LATEST_DEPLOYED_TIMESTAMP_TAG_NAME","localContractSchemas","remoteContractSchemas","warning","info"],"sources":["../../../src/plugin/serverlessContractsPlugin.ts"],"sourcesContent":["import * as Serverless from 'serverless';\nimport * as Plugin from 'serverless/classes/Plugin';\n\nimport { DeploymentStrategies } from '../types/deploymentTypes';\nimport { ContractSchemasLocation } from '../types/locations';\nimport {\n  RemoteServerlessContractSchemas,\n  ServerlessContractSchemas,\n  serviceOptionsSchema,\n} from '../types/serviceOptions';\nimport { getTimestampFromArtifactDirectoryName } from './utils/artifactDirectory';\nimport { LATEST_DEPLOYED_TIMESTAMP_TAG_NAME } from './utils/constants';\nimport { generateOpenApiDocumentation } from './utils/generateOpenApiDocumentation';\nimport { listLocalContractSchemas } from './utils/listLocalContractSchemas';\nimport { listRemoteContractSchemas } from './utils/listRemoteContractSchemas';\nimport { printContractSchemas } from './utils/printContractSchemas';\nimport { uploadContractSchemas } from './utils/uploadContractSchemas';\nimport { validateDeployment } from './utils/validateDeployment';\n\ninterface OptionsExtended extends Serverless.Options {\n  verbose?: boolean;\n  strategy?: DeploymentStrategies;\n}\n\nexport class ServerlessContractsPlugin implements Plugin {\n  cliOptions: OptionsExtended;\n  serverless: Serverless;\n  hooks: Plugin.Hooks;\n  commands: Plugin.Commands;\n  log: Plugin.Logging['log'];\n\n  constructor(\n    serverless: Serverless,\n    cliOptions: OptionsExtended,\n    { log }: Plugin.Logging,\n  ) {\n    this.cliOptions = cliOptions;\n    this.log = log;\n    // validate the 'strategy' argument\n    if (\n      this.cliOptions.strategy !== undefined &&\n      !Object.values(DeploymentStrategies).includes(this.cliOptions.strategy)\n    ) {\n      throw new Error(\n        `Invalid deployment strategy. Choices are ${JSON.stringify(\n          Object.values(DeploymentStrategies),\n        )}`,\n      );\n    }\n    this.serverless = serverless;\n\n    // add validation schema for options\n    serverless.configSchemaHandler.defineTopLevelProperty(\n      'contracts',\n      serviceOptionsSchema,\n    );\n\n    this.commands = {\n      localContracts: {\n        usage: 'Show local Serverless contracts',\n        lifecycleEvents: ['run'],\n      },\n      remoteContracts: {\n        usage: 'Show currently deployed Serverless contracts',\n        lifecycleEvents: ['run'],\n      },\n      safeDeploy: {\n        usage: 'Deploy you service and specify the deployment strategy',\n        lifecycleEvents: ['run'],\n        options: {\n          // Define the '--strategy' option with the '-s' shortcut\n          strategy: {\n            usage: 'Specify the deployment strategy',\n            shortcut: 's',\n            required: true,\n            // @ts-ignore mistype in @types/serverless\n            type: 'string',\n          },\n        },\n      },\n      generateOpenApiDocumentation: {\n        usage:\n          'Generate OpenAPI with local Serverless contracts provided by the service',\n        lifecycleEvents: ['run'],\n      },\n    };\n    this.hooks = {\n      'localContracts:run': this.printLocalServerlessContractSchemas.bind(this),\n      'remoteContracts:run':\n        this.printRemoteServerlessContractSchemas.bind(this),\n      'safeDeploy:run': this.deployWithContractSchemasValidation.bind(this),\n      'before:deploy:deploy': this.validateDeployment.bind(this),\n      'before:package:finalize': this.tagStackWithTimestamp.bind(this),\n      'after:aws:deploy:deploy:uploadArtifacts':\n        this.uploadContractSchemas.bind(this),\n      'generateOpenApiDocumentation:run':\n        this.generateOpenApiDocumentation.bind(this),\n    };\n  }\n\n  /**\n   * This command is merely a wrapper around the `deploy` command from the serverless Framework,\n   * leveraging the use of the `--strategy` option.\n   * Therefore, while this option has been set in the constructor, all we need to to is\n   * launch the serverless framework deployment\n   */\n  async deployWithContractSchemasValidation(): Promise<void> {\n    await this.serverless.pluginManager.spawn('deploy');\n  }\n\n  listLocalContractSchemas(): ServerlessContractSchemas {\n    return listLocalContractSchemas(this.serverless);\n  }\n\n  printLocalServerlessContractSchemas(): void {\n    const contractSchemas = this.listLocalContractSchemas();\n    printContractSchemas(contractSchemas, ContractSchemasLocation.LOCAL);\n  }\n\n  async printRemoteServerlessContractSchemas(): Promise<void> {\n    const contractSchemas = await this.listRemoteContractSchemas();\n    if (contractSchemas === undefined) {\n      this.log.error('Unable to retrieve remote contract schemas');\n\n      return;\n    }\n    printContractSchemas(contractSchemas, ContractSchemasLocation.REMOTE);\n  }\n\n  async listRemoteContractSchemas(): Promise<\n    RemoteServerlessContractSchemas | undefined\n  > {\n    return listRemoteContractSchemas(this.serverless);\n  }\n\n  tagStackWithTimestamp(): void {\n    const artifactDirectoryName = this.serverless.service.package\n      .artifactDirectoryName as string;\n\n    const timestamp = getTimestampFromArtifactDirectoryName(\n      artifactDirectoryName,\n    );\n\n    this.serverless.service.provider.stackTags = {\n      ...this.serverless.service.provider.stackTags,\n      [LATEST_DEPLOYED_TIMESTAMP_TAG_NAME]: timestamp,\n    };\n  }\n\n  async uploadContractSchemas(): Promise<void> {\n    await uploadContractSchemas(this.serverless, this.log);\n  }\n\n  async validateDeployment(): Promise<void> {\n    const localContractSchemas = listLocalContractSchemas(this.serverless);\n    const remoteContractSchemas = await listRemoteContractSchemas(\n      this.serverless,\n    );\n    if (remoteContractSchemas === undefined) {\n      this.log.warning(\n        'Contracts: Unable to retrieve remote contract schemas, deployment is unsafe',\n      );\n\n      return;\n    }\n\n    if (this.cliOptions.strategy !== undefined) {\n      this.log.info('Validating contract schemas...');\n\n      await validateDeployment(\n        localContractSchemas,\n        remoteContractSchemas,\n        this.cliOptions.strategy,\n      );\n    }\n  }\n\n  generateOpenApiDocumentation(): void {\n    generateOpenApiDocumentation(this.serverless);\n  }\n}\n"],"mappings":";;;;;;;;;;;;AAGA;AACA;AACA;AAKA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAgE;AAAA;AAAA,IAOnDA,yBAAyB;EAOpC,mCACEC,UAAsB,EACtBC,UAA2B,QAE3B;IAAA,IADEC,GAAG,QAAHA,GAAG;IAAA;IAEL,IAAI,CAACD,UAAU,GAAGA,UAAU;IAC5B,IAAI,CAACC,GAAG,GAAGA,GAAG;IACd;IACA,IACE,IAAI,CAACD,UAAU,CAACE,QAAQ,KAAKC,SAAS,IACtC,CAACC,MAAM,CAACC,MAAM,CAACC,qCAAoB,CAAC,CAACC,QAAQ,CAAC,IAAI,CAACP,UAAU,CAACE,QAAQ,CAAC,EACvE;MACA,MAAM,IAAIM,KAAK,oDAC+BC,IAAI,CAACC,SAAS,CACxDN,MAAM,CAACC,MAAM,CAACC,qCAAoB,CAAC,CACpC,EACF;IACH;IACA,IAAI,CAACP,UAAU,GAAGA,UAAU;;IAE5B;IACAA,UAAU,CAACY,mBAAmB,CAACC,sBAAsB,CACnD,WAAW,EACXC,oCAAoB,CACrB;IAED,IAAI,CAACC,QAAQ,GAAG;MACdC,cAAc,EAAE;QACdC,KAAK,EAAE,iCAAiC;QACxCC,eAAe,EAAE,CAAC,KAAK;MACzB,CAAC;MACDC,eAAe,EAAE;QACfF,KAAK,EAAE,8CAA8C;QACrDC,eAAe,EAAE,CAAC,KAAK;MACzB,CAAC;MACDE,UAAU,EAAE;QACVH,KAAK,EAAE,wDAAwD;QAC/DC,eAAe,EAAE,CAAC,KAAK,CAAC;QACxBG,OAAO,EAAE;UACP;UACAlB,QAAQ,EAAE;YACRc,KAAK,EAAE,iCAAiC;YACxCK,QAAQ,EAAE,GAAG;YACbC,QAAQ,EAAE,IAAI;YACd;YACAC,IAAI,EAAE;UACR;QACF;MACF,CAAC;MACDC,4BAA4B,EAAE;QAC5BR,KAAK,EACH,0EAA0E;QAC5EC,eAAe,EAAE,CAAC,KAAK;MACzB;IACF,CAAC;IACD,IAAI,CAACQ,KAAK,GAAG;MACX,oBAAoB,EAAE,IAAI,CAACC,mCAAmC,CAACC,IAAI,CAAC,IAAI,CAAC;MACzE,qBAAqB,EACnB,IAAI,CAACC,oCAAoC,CAACD,IAAI,CAAC,IAAI,CAAC;MACtD,gBAAgB,EAAE,IAAI,CAACE,mCAAmC,CAACF,IAAI,CAAC,IAAI,CAAC;MACrE,sBAAsB,EAAE,IAAI,CAACG,kBAAkB,CAACH,IAAI,CAAC,IAAI,CAAC;MAC1D,yBAAyB,EAAE,IAAI,CAACI,qBAAqB,CAACJ,IAAI,CAAC,IAAI,CAAC;MAChE,yCAAyC,EACvC,IAAI,CAACK,qBAAqB,CAACL,IAAI,CAAC,IAAI,CAAC;MACvC,kCAAkC,EAChC,IAAI,CAACH,4BAA4B,CAACG,IAAI,CAAC,IAAI;IAC/C,CAAC;EACH;;EAEA;AACF;AACA;AACA;AACA;AACA;EALE;IAAA;IAAA;MAAA,yHAMA;QAAA;UAAA;YAAA;cAAA;gBAAA;gBAAA,OACQ,IAAI,CAAC5B,UAAU,CAACkC,aAAa,CAACC,KAAK,CAAC,QAAQ,CAAC;cAAA;cAAA;gBAAA;YAAA;UAAA;QAAA;MAAA,CACpD;MAAA;QAAA;MAAA;MAAA;IAAA;EAAA;IAAA;IAAA,OAED,oCAAsD;MACpD,OAAO,IAAAC,mDAAwB,EAAC,IAAI,CAACpC,UAAU,CAAC;IAClD;EAAC;IAAA;IAAA,OAED,+CAA4C;MAC1C,IAAMqC,eAAe,GAAG,IAAI,CAACD,wBAAwB,EAAE;MACvD,IAAAE,0CAAoB,EAACD,eAAe,EAAEE,kCAAuB,CAACC,KAAK,CAAC;IACtE;EAAC;IAAA;IAAA;MAAA,0HAED;QAAA;QAAA;UAAA;YAAA;cAAA;gBAAA;gBAAA,OACgC,IAAI,CAACC,yBAAyB,EAAE;cAAA;gBAAxDJ,eAAe;gBAAA,MACjBA,eAAe,KAAKjC,SAAS;kBAAA;kBAAA;gBAAA;gBAC/B,IAAI,CAACF,GAAG,CAACwC,KAAK,CAAC,4CAA4C,CAAC;gBAAC;cAAA;gBAI/D,IAAAJ,0CAAoB,EAACD,eAAe,EAAEE,kCAAuB,CAACI,MAAM,CAAC;cAAC;cAAA;gBAAA;YAAA;UAAA;QAAA;MAAA,CACvE;MAAA;QAAA;MAAA;MAAA;IAAA;EAAA;IAAA;IAAA;MAAA,gHAED;QAAA;UAAA;YAAA;cAAA;gBAAA,kCAGS,IAAAF,qDAAyB,EAAC,IAAI,CAACzC,UAAU,CAAC;cAAA;cAAA;gBAAA;YAAA;UAAA;QAAA;MAAA,CAClD;MAAA;QAAA;MAAA;MAAA;IAAA;EAAA;IAAA;IAAA,OAED,iCAA8B;MAC5B,IAAM4C,qBAAqB,GAAG,IAAI,CAAC5C,UAAU,CAAC6C,OAAO,WAAQ,CAC1DD,qBAA+B;MAElC,IAAME,SAAS,GAAG,IAAAC,wDAAqC,EACrDH,qBAAqB,CACtB;MAED,IAAI,CAAC5C,UAAU,CAAC6C,OAAO,CAACG,QAAQ,CAACC,SAAS,mCACrC,IAAI,CAACjD,UAAU,CAAC6C,OAAO,CAACG,QAAQ,CAACC,SAAS,4CAC5CC,6CAAkC,EAAGJ,SAAS,EAChD;IACH;EAAC;IAAA;IAAA;MAAA,4GAED;QAAA;UAAA;YAAA;cAAA;gBAAA;gBAAA,OACQ,IAAAb,6CAAqB,EAAC,IAAI,CAACjC,UAAU,EAAE,IAAI,CAACE,GAAG,CAAC;cAAA;cAAA;gBAAA;YAAA;UAAA;QAAA;MAAA,CACvD;MAAA;QAAA;MAAA;MAAA;IAAA;EAAA;IAAA;IAAA;MAAA,yGAED;QAAA;QAAA;UAAA;YAAA;cAAA;gBACQiD,oBAAoB,GAAG,IAAAf,mDAAwB,EAAC,IAAI,CAACpC,UAAU,CAAC;gBAAA;gBAAA,OAClC,IAAAyC,qDAAyB,EAC3D,IAAI,CAACzC,UAAU,CAChB;cAAA;gBAFKoD,qBAAqB;gBAAA,MAGvBA,qBAAqB,KAAKhD,SAAS;kBAAA;kBAAA;gBAAA;gBACrC,IAAI,CAACF,GAAG,CAACmD,OAAO,CACd,6EAA6E,CAC9E;gBAAC;cAAA;gBAAA,MAKA,IAAI,CAACpD,UAAU,CAACE,QAAQ,KAAKC,SAAS;kBAAA;kBAAA;gBAAA;gBACxC,IAAI,CAACF,GAAG,CAACoD,IAAI,CAAC,gCAAgC,CAAC;gBAAC;gBAAA,OAE1C,IAAAvB,uCAAkB,EACtBoB,oBAAoB,EACpBC,qBAAqB,EACrB,IAAI,CAACnD,UAAU,CAACE,QAAQ,CACzB;cAAA;cAAA;gBAAA;YAAA;UAAA;QAAA;MAAA,CAEJ;MAAA;QAAA;MAAA;MAAA;IAAA;EAAA;IAAA;IAAA,OAED,wCAAqC;MACnC,IAAAsB,2DAA4B,EAAC,IAAI,CAACzB,UAAU,CAAC;IAC/C;EAAC;EAAA;AAAA;AAAA"}