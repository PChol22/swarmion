{"version":3,"file":"uploadContractSchemas.js","names":["crypto","simpleGit","COMPILED_CONTRACTS_FILE_NAME","CONTRACTS_VERSION","listLocalContractSchemas","uploadContractSchemas","serverless","log","service","provider","shouldNotDeploy","info","getProvider","getServerlessDeploymentBucketName","bucketName","artifactDirectoryName","contractSchemas","git","revparse","gitCommit","contractSchemasToUpload","contractsVersion","fileHash","createHash","update","JSON","stringify","digest","params","Bucket","Key","Body","ContentType","Metadata","filesha256","request"],"sources":["../../../../src/plugin/utils/uploadContractSchemas.ts"],"sourcesContent":["import crypto from 'crypto';\nimport * as Serverless from 'serverless';\nimport Plugin from 'serverless/classes/Plugin';\nimport { simpleGit } from 'simple-git';\n\nimport { RemoteServerlessContractSchemas } from 'types/serviceOptions';\n\nimport { COMPILED_CONTRACTS_FILE_NAME, CONTRACTS_VERSION } from './constants';\nimport { listLocalContractSchemas } from './listLocalContractSchemas';\n\nexport const uploadContractSchemas = async (\n  serverless: Serverless,\n  log: Plugin.Logging['log'],\n): Promise<void> => {\n  // @ts-ignore @types/serverless does not know this prop\n  // eslint-disable-next-line @typescript-eslint/strict-boolean-expressions\n  if (serverless.service.provider.shouldNotDeploy) {\n    log.info('Service files not changed. Skipping contract schemas upload...');\n  }\n  const provider = serverless.getProvider('aws');\n  const bucketName = await provider.getServerlessDeploymentBucketName();\n  const artifactDirectoryName = serverless.service.package\n    .artifactDirectoryName as string;\n\n  const contractSchemas = listLocalContractSchemas(serverless);\n\n  const git = simpleGit();\n\n  const gitCommit = await git.revparse('HEAD');\n\n  const contractSchemasToUpload: RemoteServerlessContractSchemas = {\n    ...contractSchemas,\n    gitCommit,\n    contractsVersion: CONTRACTS_VERSION,\n  };\n\n  const fileHash = crypto\n    .createHash('sha256')\n    .update(JSON.stringify(contractSchemasToUpload))\n    .digest('base64');\n\n  const params = {\n    Bucket: bucketName,\n    Key: `${artifactDirectoryName}/${COMPILED_CONTRACTS_FILE_NAME}`,\n    Body: JSON.stringify(contractSchemasToUpload),\n    ContentType: 'application/json',\n    Metadata: {\n      filesha256: fileHash,\n    },\n  };\n\n  log.info('Uploading contract schemas file to S3...');\n\n  await provider.request('S3', 'upload', params);\n};\n"],"mappings":";;;;;AAAA,OAAOA,MAAM,MAAM,QAAQ;AAG3B,SAASC,SAAS,QAAQ,YAAY;AAItC,SAASC,4BAA4B,EAAEC,iBAAiB;AACxD,SAASC,wBAAwB;AAEjC,OAAO,IAAMC,qBAAqB;EAAA,oEAAG,iBACnCC,UAAsB,EACtBC,GAA0B;IAAA;IAAA;MAAA;QAAA;UAAA;YAE1B;YACA;YACA,IAAID,UAAU,CAACE,OAAO,CAACC,QAAQ,CAACC,eAAe,EAAE;cAC/CH,GAAG,CAACI,IAAI,CAAC,gEAAgE,CAAC;YAC5E;YACMF,QAAQ,GAAGH,UAAU,CAACM,WAAW,CAAC,KAAK,CAAC;YAAA;YAAA,OACrBH,QAAQ,CAACI,iCAAiC,EAAE;UAAA;YAA/DC,UAAU;YACVC,qBAAqB,GAAGT,UAAU,CAACE,OAAO,WAAQ,CACrDO,qBAAqB;YAElBC,eAAe,GAAGZ,wBAAwB,CAACE,UAAU,CAAC;YAEtDW,GAAG,GAAGhB,SAAS,EAAE;YAAA;YAAA,OAECgB,GAAG,CAACC,QAAQ,CAAC,MAAM,CAAC;UAAA;YAAtCC,SAAS;YAETC,uBAAwD,mCACzDJ,eAAe;cAClBG,SAAS,EAATA,SAAS;cACTE,gBAAgB,EAAElB;YAAiB;YAG/BmB,QAAQ,GAAGtB,MAAM,CACpBuB,UAAU,CAAC,QAAQ,CAAC,CACpBC,MAAM,CAACC,IAAI,CAACC,SAAS,CAACN,uBAAuB,CAAC,CAAC,CAC/CO,MAAM,CAAC,QAAQ,CAAC;YAEbC,MAAM,GAAG;cACbC,MAAM,EAAEf,UAAU;cAClBgB,GAAG,YAAKf,qBAAqB,cAAIb,4BAA4B,CAAE;cAC/D6B,IAAI,EAAEN,IAAI,CAACC,SAAS,CAACN,uBAAuB,CAAC;cAC7CY,WAAW,EAAE,kBAAkB;cAC/BC,QAAQ,EAAE;gBACRC,UAAU,EAAEZ;cACd;YACF,CAAC;YAEDf,GAAG,CAACI,IAAI,CAAC,0CAA0C,CAAC;YAAC;YAAA,OAE/CF,QAAQ,CAAC0B,OAAO,CAAC,IAAI,EAAE,QAAQ,EAAEP,MAAM,CAAC;UAAA;UAAA;YAAA;QAAA;MAAA;IAAA;EAAA,CAC/C;EAAA,gBA5CYvB,qBAAqB;IAAA;EAAA;AAAA,GA4CjC"}