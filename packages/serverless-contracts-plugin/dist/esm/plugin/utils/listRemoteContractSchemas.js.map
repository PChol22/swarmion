{"version":3,"file":"listRemoteContractSchemas.js","names":["buildPreviousDeploymentArtifactDirectoryName","COMPILED_CONTRACTS_FILE_NAME","CONTRACTS_VERSION","getLatestDeployedTimestamp","listRemoteContractSchemas","serverless","provider","getProvider","latestDeployedTimestamp","undefined","previousArtifactDirectoryName","service","getServiceName","stage","getServerlessDeploymentBucketName","bucketName","params","Bucket","Key","request","remoteContractsBuffer","Body","provides","consumes","gitCommit","contractsVersion","contractSchemas","JSON","parse","toString"],"sources":["../../../../src/plugin/utils/listRemoteContractSchemas.ts"],"sourcesContent":["import * as S3 from 'aws-sdk/clients/s3';\nimport Serverless from 'serverless';\n\nimport { RemoteServerlessContractSchemas } from 'types/serviceOptions';\n\nimport { buildPreviousDeploymentArtifactDirectoryName } from './artifactDirectory';\nimport { COMPILED_CONTRACTS_FILE_NAME, CONTRACTS_VERSION } from './constants';\nimport { getLatestDeployedTimestamp } from './getLatestDeployedTimestamp';\n\nexport const listRemoteContractSchemas = async (\n  serverless: Serverless,\n): Promise<RemoteServerlessContractSchemas | undefined> => {\n  const provider = serverless.getProvider('aws');\n  const latestDeployedTimestamp = await getLatestDeployedTimestamp(provider);\n\n  if (latestDeployedTimestamp === undefined) return;\n\n  const previousArtifactDirectoryName =\n    buildPreviousDeploymentArtifactDirectoryName(\n      'serverless',\n      serverless.service.getServiceName(),\n      serverless.service.provider.stage,\n      latestDeployedTimestamp,\n    );\n\n  const bucketName = await provider.getServerlessDeploymentBucketName();\n\n  const params = {\n    Bucket: bucketName,\n    Key: `${previousArtifactDirectoryName}/${COMPILED_CONTRACTS_FILE_NAME}`,\n  };\n\n  const { Body: remoteContractsBuffer } = (await provider.request(\n    'S3',\n    'getObject',\n    params,\n  )) as S3.GetObjectOutput;\n\n  if (remoteContractsBuffer === undefined) {\n    return {\n      provides: {},\n      consumes: {},\n      gitCommit: '',\n      contractsVersion: CONTRACTS_VERSION,\n    };\n  }\n\n  const contractSchemas = JSON.parse(\n    remoteContractsBuffer.toString(),\n  ) as RemoteServerlessContractSchemas;\n\n  return contractSchemas;\n};\n"],"mappings":";;AAKA,SAASA,4CAA4C;AACrD,SAASC,4BAA4B,EAAEC,iBAAiB;AACxD,SAASC,0BAA0B;AAEnC,OAAO,IAAMC,yBAAyB;EAAA,oEAAG,iBACvCC,UAAsB;IAAA;IAAA;MAAA;QAAA;UAAA;YAEhBC,QAAQ,GAAGD,UAAU,CAACE,WAAW,CAAC,KAAK,CAAC;YAAA;YAAA,OACRJ,0BAA0B,CAACG,QAAQ,CAAC;UAAA;YAApEE,uBAAuB;YAAA,MAEzBA,uBAAuB,KAAKC,SAAS;cAAA;cAAA;YAAA;YAAA;UAAA;YAEnCC,6BAA6B,GACjCV,4CAA4C,CAC1C,YAAY,EACZK,UAAU,CAACM,OAAO,CAACC,cAAc,EAAE,EACnCP,UAAU,CAACM,OAAO,CAACL,QAAQ,CAACO,KAAK,EACjCL,uBAAuB,CACxB;YAAA;YAAA,OAEsBF,QAAQ,CAACQ,iCAAiC,EAAE;UAAA;YAA/DC,UAAU;YAEVC,MAAM,GAAG;cACbC,MAAM,EAAEF,UAAU;cAClBG,GAAG,YAAKR,6BAA6B,cAAIT,4BAA4B;YACvE,CAAC;YAAA;YAAA,OAE8CK,QAAQ,CAACa,OAAO,CAC7D,IAAI,EACJ,WAAW,EACXH,MAAM,CACP;UAAA;YAAA;YAJaI,qBAAqB,SAA3BC,IAAI;YAAA,MAMRD,qBAAqB,KAAKX,SAAS;cAAA;cAAA;YAAA;YAAA,iCAC9B;cACLa,QAAQ,EAAE,CAAC,CAAC;cACZC,QAAQ,EAAE,CAAC,CAAC;cACZC,SAAS,EAAE,EAAE;cACbC,gBAAgB,EAAEvB;YACpB,CAAC;UAAA;YAGGwB,eAAe,GAAGC,IAAI,CAACC,KAAK,CAChCR,qBAAqB,CAACS,QAAQ,EAAE,CACjC;YAAA,iCAEMH,eAAe;UAAA;UAAA;YAAA;QAAA;MAAA;IAAA;EAAA,CACvB;EAAA,gBA3CYtB,yBAAyB;IAAA;EAAA;AAAA,GA2CrC"}