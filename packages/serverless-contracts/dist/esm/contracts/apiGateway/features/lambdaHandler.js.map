{"version":3,"file":"lambdaHandler.js","names":["Ajv","createHttpError","isHttpError","handlerResponseToProxyResult","proxyEventToHandlerEvent","getHandler","contract","handler","event","context","_callback","ajv","parsedEvent","inputValidator","compile","inputSchema","console","error","additionalArgs","handlerResponse","outputSchema","undefined","outputValidator","expose","headers","statusCode","body","message","getLambdaHandler","additionalContext"],"sources":["../../../../../src/contracts/apiGateway/features/lambdaHandler.ts"],"sourcesContent":["import Ajv from 'ajv';\nimport createHttpError, { isHttpError } from 'http-errors';\n\nimport { ApiGatewayContract } from '../apiGatewayContract';\nimport { ApiGatewayHandler, HandlerType } from '../types';\nimport {\n  handlerResponseToProxyResult,\n  proxyEventToHandlerEvent,\n} from '../utils';\n\nexport const getHandler =\n  <Contract extends ApiGatewayContract>(contract: Contract) =>\n  (handler: HandlerType<Contract>): ApiGatewayHandler<Contract> =>\n  async (event, context, _callback, ...additionalArgs) => {\n    // here we decide to not use the callback argument passed by lambda\n    // because we have asynchronous handlers\n    try {\n      const ajv = new Ajv();\n\n      const parsedEvent = proxyEventToHandlerEvent<Contract>(event);\n\n      const inputValidator = ajv.compile(contract.inputSchema);\n      if (!inputValidator(parsedEvent)) {\n        console.error('Error: Invalid input');\n        throw createHttpError(400, 'Invalid input');\n      }\n\n      const handlerResponse = await handler(\n        parsedEvent,\n        context,\n        ...additionalArgs,\n      );\n\n      if (contract.outputSchema !== undefined) {\n        const outputValidator = ajv.compile(contract.outputSchema);\n        if (!outputValidator(handlerResponse)) {\n          console.error('Error: Invalid output');\n          throw createHttpError(400, 'Invalid output');\n        }\n      }\n\n      return handlerResponseToProxyResult(handlerResponse);\n    } catch (error) {\n      console.error(error);\n\n      if (isHttpError(error) && error.expose) {\n        return {\n          headers: error.headers,\n          statusCode: error.statusCode,\n          body: error.message,\n        };\n      }\n\n      return {\n        statusCode: 500,\n        body: 'Internal server error',\n      };\n    }\n  };\n\n/**\n * A wrapper to get the proper typing for a lambda handler.\n * This does not include parsing and validation.\n *\n * Use `getHandler` for a more advanced usage\n */\nexport const getLambdaHandler =\n  <\n    Contract extends ApiGatewayContract,\n    AdditionalContext extends\n      | Record<string, unknown>\n      | Record<never, never> = Record<never, never>,\n  >(\n    contract: Contract,\n    additionalContext: AdditionalContext,\n  ) =>\n  (\n    handler: HandlerType<typeof contract, typeof additionalContext>,\n  ): HandlerType<typeof contract, typeof additionalContext> =>\n    handler;\n"],"mappings":";;AAAA,OAAOA,GAAG,MAAM,KAAK;AACrB,OAAOC,eAAe,IAAIC,WAAW,QAAQ,aAAa;AAI1D,SACEC,4BAA4B,EAC5BC,wBAAwB;AAG1B,OAAO,IAAMC,UAAU,GACrB,SADWA,UAAU,CACiBC,QAAkB;EAAA,OACxD,UAACC,OAA8B;IAAA;MAAA,oEAC/B,iBAAOC,KAAK,EAAEC,OAAO,EAAEC,SAAS;QAAA;UAAA;UAAA;UAAA;UAAA;UAAA;UAAA;UAAA;UAAA;QAAA;UAAA;YAAA;cAAA;gBAAA;gBAItBC,GAAG,GAAG,IAAIX,GAAG,EAAE;gBAEfY,WAAW,GAAGR,wBAAwB,CAAWI,KAAK,CAAC;gBAEvDK,cAAc,GAAGF,GAAG,CAACG,OAAO,CAACR,QAAQ,CAACS,WAAW,CAAC;gBAAA,IACnDF,cAAc,CAACD,WAAW,CAAC;kBAAA;kBAAA;gBAAA;gBAC9BI,OAAO,CAACC,KAAK,CAAC,sBAAsB,CAAC;gBAAC,MAChChB,eAAe,CAAC,GAAG,EAAE,eAAe,CAAC;cAAA;gBAAA,0BAXZiB,cAAc;kBAAdA,cAAc;gBAAA;gBAAA;gBAAA,OAcjBX,OAAO,gBACnCK,WAAW,EACXH,OAAO,SACJS,cAAc,EAClB;cAAA;gBAJKC,eAAe;gBAAA,MAMjBb,QAAQ,CAACc,YAAY,KAAKC,SAAS;kBAAA;kBAAA;gBAAA;gBAC/BC,eAAe,GAAGX,GAAG,CAACG,OAAO,CAACR,QAAQ,CAACc,YAAY,CAAC;gBAAA,IACrDE,eAAe,CAACH,eAAe,CAAC;kBAAA;kBAAA;gBAAA;gBACnCH,OAAO,CAACC,KAAK,CAAC,uBAAuB,CAAC;gBAAC,MACjChB,eAAe,CAAC,GAAG,EAAE,gBAAgB,CAAC;cAAA;gBAAA,iCAIzCE,4BAA4B,CAACgB,eAAe,CAAC;cAAA;gBAAA;gBAAA;gBAEpDH,OAAO,CAACC,KAAK,aAAO;gBAAC,MAEjBf,WAAW,aAAO,IAAI,YAAMqB,MAAM;kBAAA;kBAAA;gBAAA;gBAAA,iCAC7B;kBACLC,OAAO,EAAE,YAAMA,OAAO;kBACtBC,UAAU,EAAE,YAAMA,UAAU;kBAC5BC,IAAI,EAAE,YAAMC;gBACd,CAAC;cAAA;gBAAA,iCAGI;kBACLF,UAAU,EAAE,GAAG;kBACfC,IAAI,EAAE;gBACR,CAAC;cAAA;cAAA;gBAAA;YAAA;UAAA;QAAA;MAAA,CAEJ;MAAA;QAAA;MAAA;IAAA;EAAA;AAAA;;AAEH;AACA;AACA;AACA;AACA;AACA;AACA,OAAO,IAAME,gBAAgB,GAC3B,SADWA,gBAAgB,CAOzBtB,QAAkB,EAClBuB,iBAAoC;EAAA,OAEtC,UACEtB,OAA+D;IAAA,OAE/DA,OAAO;EAAA;AAAA"}